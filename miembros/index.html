<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Miembros - Bayes Plurinacional</title>
  <style>
    body { font-family: sans-serif; max-width: 480px; margin: 60px auto; padding: 0 20px; }
    h1 { font-size: 1.2em; font-weight: normal; margin-bottom: 24px; }
    label { display: block; margin-top: 12px; font-size: 0.9em; }
    input { width: 100%; padding: 8px; margin-top: 4px; box-sizing: border-box; }
    button { margin-top: 16px; padding: 8px 20px; cursor: pointer; }
    #mensaje { margin-top: 16px; font-size: 0.9em; }
    #seccion-perfil { display: none; }
    #seccion-auth { display: none; }
  </style>
</head>
<body>

  <h1>Bayes Plurinacional - area de miembros</h1>

  <div id="seccion-auth">
    <p id="modo-texto">Ingresar con tu cuenta</p>
    <label>Email
      <input type="email" id="email">
    </label>
    <label>Contrasena
      <input type="password" id="password">
    </label>
    <button id="btn-login">Ingresar</button>
    <button id="btn-registrar">Registrarse</button>
    <div id="mensaje"></div>
  </div>

  <div id="seccion-perfil">
    <p>Bienvenido, <span id="usuario-email"></span></p>
    <label>Nombre completo
      <input type="text" id="full_name">
    </label>
    <label>Pais
      <input type="text" id="country">
    </label>
    <button id="btn-guardar">Guardar</button>
    <button id="btn-salir">Salir</button>
    <div id="mensaje-perfil"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const SUPABASE_URL  = 'https://uviqhxeyklajlqngnybn.supabase.co'
    const SUPABASE_KEY  = 'sb_publishable_CV6wcD6PxnlcbsqP7sx4Wg_PlPmMfPV'
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

    const seccionAuth   = document.getElementById('seccion-auth')
    const seccionPerfil = document.getElementById('seccion-perfil')
    const mensaje       = document.getElementById('mensaje')
    const mensajePerfil = document.getElementById('mensaje-perfil')

    async function mostrarPerfil(user) {
      seccionAuth.style.display   = 'none'
      seccionPerfil.style.display = 'block'
      document.getElementById('usuario-email').textContent = user.email

      const { data, error } = await supabase
        .from('profiles')
        .select('full_name, country')
        .eq('id', user.id)
        .single()

      if (data) {
        document.getElementById('full_name').value = data.full_name || ''
        document.getElementById('country').value   = data.country   || ''
      }
    }

    // Verificar sesion activa al cargar
    const { data: { session } } = await supabase.auth.getSession()
    if (session) {
      mostrarPerfil(session.user)
    } else {
      seccionAuth.style.display = 'block'
    }

    // Login
    document.getElementById('btn-login').addEventListener('click', async () => {
      const email    = document.getElementById('email').value
      const password = document.getElementById('password').value
      const { data, error } = await supabase.auth.signInWithPassword({ email, password })
      if (error) { mensaje.textContent = 'Error: ' + error.message; return }
      mostrarPerfil(data.user)
    })

    // Registro
    document.getElementById('btn-registrar').addEventListener('click', async () => {
      const email    = document.getElementById('email').value
      const password = document.getElementById('password').value
      const { error } = await supabase.auth.signUp({ email, password })
      if (error) { mensaje.textContent = 'Error: ' + error.message; return }
      mensaje.textContent = 'Revisa tu email para confirmar el registro.'
    })

    // Guardar perfil
    document.getElementById('btn-guardar').addEventListener('click', async () => {
      const { data: { user } } = await supabase.auth.getUser()
      const { error } = await supabase
        .from('profiles')
        .update({
          full_name:  document.getElementById('full_name').value,
          country:    document.getElementById('country').value,
          updated_at: new Date().toISOString()
        })
        .eq('id', user.id)
      mensajePerfil.textContent = error ? 'Error: ' + error.message : 'Guardado.'
    })

    // Salir
    document.getElementById('btn-salir').addEventListener('click', async () => {
      await supabase.auth.signOut()
      seccionPerfil.style.display = 'none'
      seccionAuth.style.display   = 'block'
      mensaje.textContent = ''
    })
  </script>

</body>
</html>
